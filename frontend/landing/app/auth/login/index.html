<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SuiStrategy</title>
    <link rel="stylesheet" href="../../../styles.css">
    <link rel="stylesheet" href="login.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Sui TypeScript SDK -->
    <script src="https://unpkg.com/@mysten/sui.js@1.0.0/dist/index.iife.js"></script>
    
    <!-- Sui Wallet Standard -->
    <script src="https://unpkg.com/@wallet-standard/core@latest/lib/index.js"></script>
    <script src="https://unpkg.com/@mysten/wallet-standard@latest/dist/index.iife.js"></script>
    
    <!-- Contract Configuration (auto-generated by deploy script) -->
    <script src="contract-config.js" onerror="console.log('Contract not deployed yet')"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="../../../" class="nav-logo">
                    <img src="../../../assets/logo.svg" alt="SuiStrategy Logo" class="logo-icon">
                    <span class="logo-text">SuiStrategy</span>
                </a>
                <div class="nav-menu">
                    <a href="../../../" class="nav-link">‚Üê Back to Landing</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="login-main">
        <div class="container">
            <div class="login-container">
                <!-- Login Header -->
                <div class="login-header">
                    <h1 class="login-title">Connect Sui Wallet to SuiStrategy</h1>
                    <p class="login-description">
                        Connect your Sui Wallet to access leveraged yield strategies and treasury management on Sui blockchain.
                    </p>
                </div>

                <!-- Wallet Connection Section -->
                <section class="wallet-section">
                    <div class="wallet-grid">
                        <button class="wallet-card" data-wallet="sui-wallet" id="sui-wallet-card">
                            <div class="wallet-icon">
                                <img src="../../../assets/logo.svg" alt="Sui Wallet" class="wallet-logo">
                            </div>
                                            <div class="wallet-info">
                    <h4 class="wallet-name">Sui Wallet</h4>
                    <p class="wallet-desc">Official Sui blockchain wallet (Testnet required)</p>
                </div>
                            <div class="wallet-status" id="sui-status">
                                <span class="status-dot"></span>
                                <span class="status-text">Checking...</span>
                            </div>
                        </button>
                    </div>
                    
                                <div style="text-align: center; margin-top: 20px; padding: 20px; background: rgba(77, 162, 255, 0.1); border-radius: 12px;">
                <p style="margin: 0 0 10px 0; color: #c0e6ff;">
                    <strong>‚ö†Ô∏è Important:</strong> Make sure your Sui Wallet is connected to <strong>Testnet</strong>
                </p>
                <p style="margin: 0; color: #c0e6ff;">
                    Don't have Sui Wallet? 
                    <a href="https://chrome.google.com/webstore/detail/sui-wallet/opcgpfmipidbgpenhmajoajpbobppdil" 
                       target="_blank" 
                       style="color: #4da2ff; text-decoration: none; font-weight: 500;">
                        Install it here ‚Üí
                    </a>
                </p>
            </div>
                </section>

                <!-- User Role Selection -->
                <section class="role-selection" id="roleSelection" style="display: none;">
                    <h2 class="section-title">Choose Your Strategy</h2>
                    <div class="role-grid">
                        <div class="role-card" data-role="sstr-holder">
                            <div class="role-header">
                                <div class="role-icon">
                                    <img src="../../../assets/logo.svg" alt="SSTR" class="role-logo">
                                </div>
                                <h3 class="role-title">SSTR Holder</h3>
                                <div class="role-badge">Leverage Strategy</div>
                            </div>
                            <p class="role-description">
                                Get leveraged exposure to SUI growth through treasury-backed tokens. 
                                Earn yield while maintaining upside potential without liquidation risk.
                            </p>
                            <ul class="role-features">
                                <li>‚úì Leveraged SUI exposure</li>
                                <li>‚úì Treasury-backed value</li>
                                <li>‚úì No liquidation risk</li>
                                <li>‚úì Automated yield strategies</li>
                            </ul>
                            <button class="btn btn-primary role-btn">Start with SSTR</button>
                        </div>

                        <div class="role-card" data-role="bond-purchaser">
                            <div class="role-header">
                                <div class="role-icon">
                                    <div class="role-placeholder">üí∞</div>
                                </div>
                                <h3 class="role-title">Bond Purchaser</h3>
                                <div class="role-badge">Fixed Income</div>
                            </div>
                            <p class="role-description">
                                Fund the treasury with stablecoins to receive convertible debt tokens (CDT) 
                                and option NFTs. Flexible strategies from conversion to redemption.
                            </p>
                            <ul class="role-features">
                                <li>‚úì 0% interest debt tokens</li>
                                <li>‚úì Option NFTs included</li>
                                <li>‚úì Convert to SSTR anytime</li>
                                <li>‚úì Stable asset backing</li>
                            </ul>
                            <button class="btn btn-secondary role-btn">Start Bonding</button>
                        </div>
                    </div>
                </section>

                <!-- Debug Section -->
                <section class="debug-section" style="background: #011829; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #f59e0b;">
                    <h3 style="color: #f59e0b; margin-top: 0;">üîß Wallet Issues? Try These:</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;">
                        <button onclick="forceDetectWallet()" style="background: #f59e0b; color: #000; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">üîç Force Detect</button>
                        <button onclick="debugWalletState()" style="background: #22c55e; color: #000; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">üêõ Debug Console</button>
                        <button onclick="debugSDK()" style="background: #f97316; color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">üîç Debug SDK</button>
                        <button onclick="checkExtensions()" style="background: #9333ea; color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">üîå Check Extensions</button>
                        <button onclick="checkNetwork()" style="background: #8b5cf6; color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">üåê Check Network</button>
                        <button onclick="manualConnect()" style="background: #4da2ff; color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">‚ö° Force Connect</button>
                        <button onclick="window.location.reload()" style="background: #ef4444; color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">üîÑ Refresh Page</button>
                    </div>
                    <div id="debug-output" style="background: #000; color: #0f0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto; display: none;"></div>
                </section>

                <!-- Protocol Status -->
                <section class="protocol-status">
                    <h3 class="status-title">Protocol Status</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">Treasury Value</span>
                            <span class="status-value">$2.4M</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">SSTR Price</span>
                            <span class="status-value">$12.34</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Yield APY</span>
                            <span class="status-value">8.7%</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Network</span>
                            <span class="status-value network-status">
                                <span class="network-dot"></span>
                                Sui Testnet
                            </span>
                        </div>
                    </div>
                </section>

                <!-- Loading State -->
                <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <h3 class="loading-title">Connecting Wallet...</h3>
                        <p class="loading-text">Please approve the connection in your wallet</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3 class="footer-title">Security</h3>
                    <div class="footer-links">
                        <a href="#" class="footer-link">Audit Reports</a>
                        <a href="#" class="footer-link">Bug Bounty</a>
                        <a href="#" class="footer-link">Terms of Service</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3 class="footer-title">Support</h3>
                    <div class="footer-links">
                        <a href="#" class="footer-link">Documentation</a>
                        <a href="#" class="footer-link">Discord</a>
                        <a href="#" class="footer-link">Help Center</a>
                    </div>
                </div>
                <div class="footer-section">
                    <p class="footer-disclaimer">
                        By connecting your wallet, you agree to our Terms of Service and acknowledge 
                        the risks associated with DeFi protocols. Not financial advice.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // CONTRACT_CONFIG will be loaded from contract-config.js

        // Global variables
        const walletCards = document.querySelectorAll('.wallet-card');
        const roleSelection = document.getElementById('roleSelection');
        const loadingOverlay = document.getElementById('loadingOverlay');
        let currentWallet = null;
        let suiClient = null;
        let connectedAccount = null;

        // Initialize Sui client
        function initializeSuiClient() {
            try {
                // Check for Sui SDK availability under different possible global names
                let SuiSDK = null;
                const possibleNames = ['sui', 'SuiSDK', 'Sui', 'suijs', 'SuiJS', 'SuiClient'];
                
                console.log('üîç Checking for Sui SDK...');
                console.log('All globals:', Object.keys(window).filter(k => !k.startsWith('webkit')).slice(0, 30));
                
                for (const name of possibleNames) {
                    if (window[name]) {
                        console.log(`Found window.${name}:`, typeof window[name], window[name]);
                        if (window[name].SuiClient) {
                            SuiSDK = window[name];
                            console.log(`‚úÖ Found Sui SDK at window.${name}`);
                            break;
                        } else if (typeof window[name] === 'function' && name === 'SuiClient') {
                            // Direct SuiClient constructor
                            SuiSDK = { SuiClient: window[name] };
                            console.log(`‚úÖ Found direct SuiClient constructor`);
                            break;
                        }
                    }
                }
                
                if (!SuiSDK) {
                    console.log('‚ùå No Sui SDK found. Will skip network operations.');
                    return false;
                }
                
                const rpcUrl = (typeof CONTRACT_CONFIG !== 'undefined' && CONTRACT_CONFIG.rpcUrl) 
                    ? CONTRACT_CONFIG.rpcUrl 
                    : 'https://fullnode.testnet.sui.io:443';
                
                suiClient = new SuiSDK.SuiClient({
                    url: rpcUrl
                });
                console.log('‚úÖ Sui client initialized with URL:', rpcUrl);
                console.log('‚úÖ SDK object type:', typeof SuiSDK);
                
                return true;
            } catch (error) {
                console.error('‚ùå Failed to initialize Sui client:', error);
                console.log('‚ùå Will continue without SDK - wallet operations may still work');
                suiClient = null;
                return false;
            }
        }

        // Sui Wallet detection and management
        async function detectSuiWallet() {
            try {
                let suiWalletFound = false;
                
                console.log('üîç Detecting Sui Wallet...');
                console.log('Current URL:', window.location.href);
                console.log('Browser info:', navigator.userAgent);
                
                // Method 1: Check for direct window.suiWallet
                if (typeof window.suiWallet !== 'undefined') {
                    console.log('‚úÖ Sui Wallet found via window.suiWallet:', typeof window.suiWallet);
                    suiWalletFound = true;
                }
                
                // Method 2: Check for alternative wallet object names  
                if (!suiWalletFound) {
                    const alternativeNames = ['sui', 'SuiWallet', 'mySuiWallet', 'suiWallet'];
                    for (const name of alternativeNames) {
                        if (typeof window[name] !== 'undefined') {
                            console.log(`‚úÖ Sui Wallet found via window.${name}:`, typeof window[name]);
                            suiWalletFound = true;
                            // Set standard reference
                            if (!window.suiWallet && (window[name].connect || window[name].requestPermissions)) {
                                window.suiWallet = window[name];
                                console.log(`üìå Set window.suiWallet = window.${name}`);
                            }
                            break;
                        }
                    }
                }
                
                // Method 3: Search all window properties for wallet-like objects
                if (!suiWalletFound) {
                    const allProps = Object.keys(window);
                    const walletProps = allProps.filter(prop => 
                        prop.toLowerCase().includes('sui') || 
                        (window[prop] && typeof window[prop] === 'object' && 
                         (window[prop].connect || window[prop].requestPermissions))
                    );
                    
                    if (walletProps.length > 0) {
                        console.log('üîç Found wallet-like properties:', walletProps);
                        for (const prop of walletProps) {
                            if (window[prop] && (window[prop].connect || window[prop].requestPermissions)) {
                                console.log(`‚úÖ Found wallet object at window.${prop}`);
                                window.suiWallet = window[prop];
                                suiWalletFound = true;
                                break;
                            }
                        }
                    }
                }
                
                // Method 4: Check for wallet standard (if available)
                if (!suiWalletFound) {
                    try {
                        if (typeof SuiWalletStandard !== 'undefined') {
                            const { getWallets } = SuiWalletStandard;
                            const availableWallets = getWallets();
                            console.log('Available wallets via standard:', availableWallets.map(w => w.name || 'unnamed'));
                            
                            const suiWallet = availableWallets.find(w => 
                                (w.name && w.name.toLowerCase().includes('sui')) ||
                                (w.icon && w.icon.includes('sui'))
                            );
                            if (suiWallet) {
                                console.log('‚úÖ Sui Wallet found via wallet standard:', suiWallet.name);
                                suiWalletFound = true;
                            }
                        }
                    } catch (e) {
                        console.log('Wallet standard check failed:', e.message);
                    }
                }
                
                // Method 5: Check if we're on file:// protocol (which blocks extensions)
                if (!suiWalletFound && window.location.protocol === 'file:') {
                    console.log('‚ö†Ô∏è Running on file:// protocol - Chrome extensions may not work');
                    console.log('üí° Try serving via HTTP server or opening in localhost');
                }
                
                // Update UI based on detection
                if (suiWalletFound) {
                    updateWalletStatus('sui-status', 'detected');
                    console.log('‚úÖ Sui Wallet ready for connection');
                } else {
                    console.log('‚ùå Sui Wallet not detected');
                    updateWalletStatus('sui-status', 'install');
                    
                    // Show available globals for debugging
                    const relevantGlobals = Object.keys(window).filter(k => 
                        k.toLowerCase().includes('wallet') || 
                        k.toLowerCase().includes('sui') ||
                        k.toLowerCase().includes('extension')
                    );
                    if (relevantGlobals.length > 0) {
                        console.log('üîç Found relevant globals:', relevantGlobals);
                    }
                    
                    // Retry after delay (wallet might load late)
                    setTimeout(() => {
                        detectSuiWallet();
                    }, 2000);
                }

            } catch (error) {
                console.error('Error detecting Sui Wallet:', error);
                updateWalletStatus('sui-status', 'error');
            }
        }

        function updateWalletStatus(statusId, status) {
            const statusElement = document.getElementById(statusId);
            if (statusElement) {
                const dot = statusElement.querySelector('.status-dot');
                const text = statusElement.querySelector('.status-text');
                
                // Remove existing classes
                dot.classList.remove('available');
                
                switch (status) {
                    case 'detected':
                        dot.classList.add('available');
                        text.textContent = 'Connect';
                        break;
                    case 'connected':
                        dot.classList.add('available');
                        text.textContent = 'Connected';
                        text.style.color = '#22c55e';
                        break;
                    case 'install':
                        text.textContent = 'Install Required';
                        text.style.color = '#ef4444';
                        break;
                    case 'error':
                        text.textContent = 'Error';
                        text.style.color = '#ef4444';
                        break;
                    default:
                        text.textContent = 'Checking...';
                        break;
                }
            }
        }

        // Single wallet connection handler
        document.getElementById('sui-wallet-card').addEventListener('click', async function() {
            await connectSuiWallet();
        });

        async function connectSuiWallet() {
            loadingOverlay.style.display = 'flex';
            
            try {
                console.log('üîó Attempting to connect to Sui Wallet...');
                
                // Find Sui Wallet
                let suiWallet = null;
                
                // Method 1: Direct window.suiWallet
                if (window.suiWallet) {
                    suiWallet = window.suiWallet;
                    console.log('Using window.suiWallet');
                }
                
                // Method 2: Check alternative names
                if (!suiWallet) {
                    const alternativeNames = ['sui', 'SuiWallet'];
                    for (const name of alternativeNames) {
                        if (window[name]) {
                            suiWallet = window[name];
                            console.log(`Using window.${name}`);
                            break;
                        }
                    }
                }
                
                // Method 3: Wallet Standard API
                if (!suiWallet) {
                    try {
                        if (typeof SuiWalletStandard !== 'undefined') {
                            const { getWallets } = SuiWalletStandard;
                            const availableWallets = getWallets();
                            suiWallet = availableWallets.find(w => w.name === 'Sui Wallet');
                            if (suiWallet) {
                                console.log('Using wallet standard API');
                            }
                        }
                    } catch (e) {
                        console.log('Wallet standard not available');
                    }
                }
                
                if (!suiWallet) {
                    throw new Error('Sui Wallet not found. Please install Sui Wallet extension and refresh the page.');
                }
                
                // Try different connection methods
                let accounts = [];
                
                try {
                    // Method A: Wallet Standard connect
                    if (suiWallet.features && suiWallet.features['standard:connect']) {
                        console.log('Connecting via wallet standard...');
                        const result = await suiWallet.features['standard:connect'].connect();
                        accounts = result.accounts;
                    }
                    // Method B: requestPermissions + getAccounts
                    else if (suiWallet.requestPermissions && suiWallet.getAccounts) {
                        console.log('Connecting via requestPermissions...');
                        await suiWallet.requestPermissions();
                        accounts = await suiWallet.getAccounts();
                    }
                    // Method C: Direct connect method
                    else if (suiWallet.connect) {
                        console.log('Connecting via direct connect...');
                        const result = await suiWallet.connect();
                        accounts = result.accounts || [result.account] || [result];
                    }
                    else {
                        throw new Error('No supported connection method found');
                    }
                } catch (connectionError) {
                    console.error('Connection attempt failed:', connectionError);
                    throw new Error(`Connection failed: ${connectionError.message}. Please make sure your Sui Wallet is unlocked and try again.`);
                }
                
                if (accounts && accounts.length > 0) {
                    currentWallet = suiWallet;
                    connectedAccount = accounts[0];
                    
                    console.log('‚úÖ Connected account:', connectedAccount);
                    
                    // Check network compatibility
                    const networkValid = await checkNetworkCompatibility();
                    if (!networkValid) {
                        updateWalletStatus('sui-status', 'error');
                        const statusText = document.querySelector('#sui-status .status-text');
                        if (statusText) {
                            statusText.textContent = 'Wrong network - Switch to Testnet';
                        }
                        throw new Error('‚ö†Ô∏è Network Mismatch: Please switch your Sui Wallet to Testnet network.\n\nTo switch networks:\n1. Open Sui Wallet\n2. Click the network dropdown\n3. Select "Testnet"');
                    }
                    
                    // Update UI
                    updateWalletStatus('sui-status', 'connected');
                    
                    // Fetch real protocol data
                    await updateProtocolStatus();
                    
                    // Show role selection
                    roleSelection.style.display = 'block';
                    roleSelection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error('No accounts found. Please create an account in your Sui Wallet.');
                }

                loadingOverlay.style.display = 'none';
                
            } catch (error) {
                loadingOverlay.style.display = 'none';
                console.error('Sui Wallet connection error:', error);
                
                // Update status to show error
                updateWalletStatus('sui-status', 'error');
                
                // Show user-friendly error
                alert(`Failed to connect to Sui Wallet: ${error.message}`);
            }
        }

        function updateConnectedState(walletType) {
            const walletCard = document.querySelector(`[data-wallet="${walletType}"]`);
            if (walletCard) {
                walletCard.classList.add('connected');
                updateWalletStatus(walletCard.querySelector('.wallet-status').id, 'connected');
            }
        }

        // Protocol status fetching
        async function updateProtocolStatus() {
            if (!suiClient || CONTRACT_CONFIG.packageId === '0x0') {
                console.log('Contract not deployed yet, using mock data');
                return;
            }

            try {
                // Fetch treasury object
                const treasuryObjects = await suiClient.getOwnedObjects({
                    owner: CONTRACT_CONFIG.packageId,
                    filter: {
                        StructType: `${CONTRACT_CONFIG.packageId}::suistrategy::Treasury`
                    }
                });

                if (treasuryObjects.data.length > 0) {
                    const treasuryId = treasuryObjects.data[0].data.objectId;
                    
                    // Get treasury details
                    const treasuryObject = await suiClient.getObject({
                        id: treasuryId,
                        options: {
                            showContent: true
                        }
                    });

                    const fields = treasuryObject.data.content.fields;
                    
                    // Update UI with real data
                    updateStatusDisplay('treasury-value', `${formatSUI(fields.sui_balance)}`)
                    updateStatusDisplay('cdt-supply', fields.total_cdt_supply);
                    updateStatusDisplay('sstr-supply', fields.total_sstr_supply);
                    updateStatusDisplay('bond-counter', fields.bond_counter);

                    // Calculate NAV
                    const navResult = await calculateNAV(treasuryId);
                    if (navResult) {
                        updateStatusDisplay('sstr-price', `$${(navResult.nav_per_sstr / 10000).toFixed(2)}`);
                    }
                }

            } catch (error) {
                console.error('Error fetching protocol status:', error);
            }
        }

        async function calculateNAV(treasuryId) {
            try {
                const result = await suiClient.devInspectTransactionBlock({
                    transactionBlock: {
                        kind: 'moveCall',
                        target: `${CONTRACT_CONFIG.packageId}::suistrategy::calculate_nav`,
                        arguments: [treasuryId]
                    },
                    sender: connectedAccount.address
                });

                if (result.results && result.results[0] && result.results[0].returnValues) {
                    const [treasuryValue, sstrSupply, navPerSstr] = result.results[0].returnValues;
                    return {
                        treasury_value: parseInt(treasuryValue[0]),
                        sstr_supply: parseInt(sstrSupply[0]),
                        nav_per_sstr: parseInt(navPerSstr[0])
                    };
                }
            } catch (error) {
                console.error('Error calculating NAV:', error);
                return null;
            }
        }

        function updateStatusDisplay(elementClass, value) {
            const elements = document.querySelectorAll(`.${elementClass}`);
            elements.forEach(el => {
                el.textContent = value;
            });
        }

        function formatSUI(balance) {
            return (parseInt(balance) / 1000000000).toFixed(2) + ' SUI';
        }

        // Role selection handlers
        const roleCards = document.querySelectorAll('.role-card');
        roleCards.forEach(card => {
            card.addEventListener('click', function() {
                const role = this.dataset.role;
                selectRole(role);
            });
        });

        function selectRole(role) {
            if (!connectedAccount) {
                alert('Please connect your wallet first');
                return;
            }

            console.log(`Selected role: ${role} with wallet:`, connectedAccount);
            
            // Store user preference
            localStorage.setItem('suistrategy_user_role', role);
            localStorage.setItem('suistrategy_wallet_address', connectedAccount.address);
            
            // Navigate to appropriate interface
            if (role === 'sstr-holder') {
                // Navigate to SSTR dashboard
                window.location.href = '../../../dashboard/sstr/';
            } else {
                // Navigate to bonding interface  
                window.location.href = '../../../dashboard/bonding/';
            }
        }

        // Deployment helper for testing
        window.setSuiStrategyContract = function(packageId) {
            CONTRACT_CONFIG.packageId = packageId;
            console.log('SuiStrategy contract set to:', packageId);
            updateProtocolStatus();
        };

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait a bit for SDK to load
            setTimeout(async () => {
                console.log('üöÄ Initializing SuiStrategy app...');
                console.log('Available window properties:', Object.keys(window).filter(k => k.toLowerCase().includes('sui')));
                
                const sdkLoaded = initializeSuiClient();
                if (!sdkLoaded) {
                    console.log('‚ö†Ô∏è Sui SDK failed to load. You can still try wallet connections.');
                    console.log('üí° Use the "üîç Debug SDK" button to troubleshoot.');
                }
                
                await detectSuiWallet();
                
                // Check if we're on local development
                if (typeof CONTRACT_CONFIG !== 'undefined' && CONTRACT_CONFIG.network === 'localnet') {
                    console.log('Running on localnet. Deploy your contract and call window.setSuiStrategyContract(packageId)');
                }
                
                // Update status periodically
                setInterval(updateProtocolStatus, 30000);
            }, 1000);
        });

        // Network status checker
        async function checkNetworkStatus() {
            try {
                const health = await suiClient.getRpcApiVersion();
                const networkDot = document.querySelector('.network-dot');
                if (networkDot) {
                    networkDot.style.background = '#22c55e';
                }
            } catch (error) {
                const networkDot = document.querySelector('.network-dot');
                if (networkDot) {
                    networkDot.style.background = '#ef4444';
                }
            }
        }

        // Check network status on load and periodically
        document.addEventListener('DOMContentLoaded', function() {
            checkNetworkStatus();
            setInterval(checkNetworkStatus, 10000);
        });

        // Network compatibility check
        async function checkNetworkCompatibility() {
            try {
                if (!suiClient) {
                    console.log('No Sui client available for network check');
                    return false;
                }
                
                // Try to query our deployed contract to verify network
                if (typeof CONTRACT_CONFIG !== 'undefined' && CONTRACT_CONFIG.packageId && CONTRACT_CONFIG.packageId !== '0x0') {
                    const result = await suiClient.getObject({
                        id: CONTRACT_CONFIG.packageId,
                        options: { showType: true }
                    });
                    
                    console.log('Network check result:', result);
                    return result && !result.error;
                }
                
                return true; // If no contract config, assume compatible
            } catch (error) {
                console.log('Network compatibility check failed:', error);
                return false;
            }
        }

        // Debug functions for wallet troubleshooting
        function debugLog(message) {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.style.display = 'block';
            debugOutput.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n';
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log('DEBUG:', message);
        }

        window.forceDetectWallet = function() {
            debugLog('üîç Force detecting Sui Wallet...');
            
            // Check all possible Sui wallet locations
            const walletChecks = [
                'window.suiWallet',
                'window.sui', 
                'window.SuiWallet'
            ];
            
            walletChecks.forEach(check => {
                try {
                    const value = eval(check);
                    if (value) {
                        debugLog(`‚úÖ Found: ${check}`);
                        if (check.includes('sui') && !window.suiWallet) {
                            window.suiWallet = value;
                            debugLog(`üìå Set window.suiWallet = ${check}`);
                        }
                    } else {
                        debugLog(`‚ùå Missing: ${check}`);
                    }
                } catch (e) {
                    debugLog(`‚ùå Error checking ${check}: ${e.message}`);
                }
            });
            
            // Force re-detect
            detectSuiWallet();
            debugLog('üîÑ Detection complete');
        };

        window.debugWalletState = function() {
            debugLog('üêõ Debugging wallet state...');
            
            // Log current state
            debugLog(`Browser: ${navigator.userAgent.split(' ').pop()}`);
            debugLog(`URL: ${window.location.href}`);
            debugLog(`Protocol: ${window.location.protocol}`);
            
            // Check wallet objects
            if (window.suiWallet) {
                debugLog(`‚úÖ window.suiWallet exists`);
                debugLog(`Type: ${typeof window.suiWallet}`);
                debugLog(`Methods: ${Object.getOwnPropertyNames(window.suiWallet)}`);
            } else {
                debugLog(`‚ùå window.suiWallet not found`);
            }
            
            // Check for wallet in different scopes
            try {
                const walletNames = Object.getOwnPropertyNames(window).filter(name => 
                    name.toLowerCase().includes('sui') || 
                    name.toLowerCase().includes('wallet')
                );
                debugLog(`Wallet-related properties: ${walletNames.join(', ')}`);
            } catch (e) {
                debugLog(`Error scanning window: ${e.message}`);
            }
            
            // Open console for user
            debugLog('üìù Check browser console (F12) for more details');
            console.log('=== SuiStrategy Wallet Debug ===');
            console.log('window.suiWallet:', window.suiWallet);
            console.log('window.ethereum:', window.ethereum);
            console.log('All window properties with "sui":', Object.getOwnPropertyNames(window).filter(n => n.toLowerCase().includes('sui')));
            console.log('Expected network: testnet');
            console.log('CONTRACT_CONFIG:', typeof CONTRACT_CONFIG !== 'undefined' ? CONTRACT_CONFIG : 'Not loaded');
        };

        window.checkNetwork = function() {
            debugLog('üåê Checking network compatibility...');
            checkNetworkCompatibility().then(result => {
                debugLog(`Network compatible: ${result}`);
                if (!result) {
                    debugLog('‚ùå Switch your Sui Wallet to Testnet network');
                } else {
                    debugLog('‚úÖ Network is compatible');
                }
            }).catch(error => {
                debugLog(`‚ùå Network check error: ${error.message}`);
            });
        };

        window.debugSDK = function() {
            debugLog('üîç Debugging Sui SDK...');
            const possibleNames = ['sui', 'SuiSDK', 'Sui', 'suijs', 'SuiJS'];
            possibleNames.forEach(name => {
                if (window[name]) {
                    debugLog(`‚úÖ Found window.${name}:`, typeof window[name]);
                    if (window[name].SuiClient) {
                        debugLog(`  - Has SuiClient: ${typeof window[name].SuiClient}`);
                    }
                } else {
                    debugLog(`‚ùå Missing window.${name}`);
                }
            });
            
            debugLog('üìù All window properties with "sui":', Object.keys(window).filter(k => k.toLowerCase().includes('sui')));
        };

        window.checkExtensions = function() {
            debugLog('üîç Checking for browser extensions...');
            
            // Check for common extension injection patterns
            const extensionChecks = [
                'window.chrome',
                'window.browser', 
                'document.documentElement.getAttribute("data-extension")',
                'window.ethereum', // Many wallets also inject ethereum
                'window.solana',   // Solana wallets
                'window.aptos'     // Aptos wallets
            ];
            
            extensionChecks.forEach(check => {
                try {
                    const result = eval(check);
                    if (result) {
                        debugLog(`‚úÖ Found: ${check}`);
                    } else {
                        debugLog(`‚ùå Missing: ${check}`);
                    }
                } catch (e) {
                    debugLog(`‚ùå Error checking ${check}: ${e.message}`);
                }
            });
            
            // Check for script tags that might indicate extension injection
            const scripts = Array.from(document.scripts);
            const extensionScripts = scripts.filter(script => 
                script.src && (
                    script.src.includes('extension://') || 
                    script.src.includes('chrome-extension://') ||
                    script.src.includes('moz-extension://')
                )
            );
            
            if (extensionScripts.length > 0) {
                debugLog(`‚úÖ Found ${extensionScripts.length} extension scripts`);
                extensionScripts.forEach(script => {
                    debugLog(`  - ${script.src}`);
                });
            } else {
                debugLog('‚ùå No extension scripts found');
            }
            
            // Check for content script markers
            const contentScriptMarkers = document.querySelectorAll('[data-extension-id]');
            if (contentScriptMarkers.length > 0) {
                debugLog(`‚úÖ Found ${contentScriptMarkers.length} content script markers`);
            } else {
                debugLog('‚ùå No content script markers found');
            }
        };

        window.manualConnect = async function() {
            debugLog('‚ö° Attempting manual connection...');
            
            try {
                // Try to find any wallet object
                let walletObj = window.suiWallet || window.sui || window.SuiWallet;
                
                if (!walletObj) {
                    debugLog('‚ùå No wallet object found');
                    alert('No Sui wallet found. Please:\n1. Install Sui Wallet extension\n2. Refresh this page\n3. Try again');
                    return;
                }
                
                debugLog('‚úÖ Found wallet object, attempting connection...');
                
                // Try different connection methods
                let result = null;
                
                if (walletObj.requestPermissions) {
                    debugLog('üìã Trying requestPermissions...');
                    result = await walletObj.requestPermissions();
                    debugLog(`Result: ${JSON.stringify(result)}`);
                    
                    if (walletObj.getAccounts) {
                        const accounts = await walletObj.getAccounts();
                        debugLog(`Accounts: ${JSON.stringify(accounts)}`);
                        
                        if (accounts && accounts.length > 0) {
                            debugLog('üéâ Manual connection successful!');
                            connectedAccount = accounts[0];
                            updateWalletStatus('sui-status', 'connected');
                            roleSelection.style.display = 'block';
                            roleSelection.scrollIntoView({ behavior: 'smooth' });
                            return;
                        }
                    }
                }
                
                if (walletObj.connect) {
                    debugLog('üîó Trying direct connect...');
                    result = await walletObj.connect();
                    debugLog(`Connect result: ${JSON.stringify(result)}`);
                }
                
                debugLog('‚ö†Ô∏è Connection attempt completed, check results above');
                
            } catch (error) {
                debugLog(`‚ùå Manual connection failed: ${error.message}`);
                console.error('Manual connection error:', error);
                alert(`Connection failed: ${error.message}\n\nPlease make sure:\n1. Sui Wallet is installed\n2. Wallet is unlocked\n3. Try refreshing the page`);
            }
        }

        // Global debug helpers
        window.debugSuiStrategy = {
            forceDetect: forceDetectWallet,
            debugState: debugWalletState,
            manualConnect: manualConnect,
            showWallet: () => {
                console.log('window.suiWallet:', window.suiWallet);
                console.log('window.sui:', window.sui);
                console.log('window.SuiWallet:', window.SuiWallet);
                return window.suiWallet || window.sui || window.SuiWallet;
            }
        };
    </script>
</body>
</html>
